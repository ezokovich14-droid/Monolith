{% extends "base.html" %}
{% block title %}Commandes{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-shopping-cart text-green-600 mr-3"></i>
                Gestion des Commandes
            </h2>
            <p class="text-gray-600 mt-2">Suivez et gérez toutes les commandes clients</p>
        </div>
        <button onclick="showAddOrderModal()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center">
            <i class="fas fa-plus mr-2"></i>
            Nouvelle commande
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Total commandes</p>
                    <p class="text-2xl font-bold text-gray-800" id="total-orders">0</p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <i class="fas fa-shopping-cart text-blue-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">En attente</p>
                    <p class="text-2xl font-bold text-yellow-600" id="pending-orders">0</p>
                </div>
                <div class="bg-yellow-100 rounded-full p-3">
                    <i class="fas fa-clock text-yellow-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Terminées</p>
                    <p class="text-2xl font-bold text-green-600" id="completed-orders">0</p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-check text-green-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Chiffre d'affaires</p>
                    <p class="text-2xl font-bold text-gray-800" id="total-revenue">0€</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <i class="fas fa-euro-sign text-purple-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Rechercher une commande..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            <select id="status-filter"
                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                <option value="">Tous les statuts</option>
                <option value="pending">En attente</option>
                <option value="processing">En cours</option>
                <option value="shipped">Expédiée</option>
                <option value="delivered">Livrée</option>
                <option value="cancelled">Annulée</option>
            </select>
            <select id="sort-select"
                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                <option value="created">Date de création</option>
                <option value="total">Montant total</option>
                <option value="status">Statut</option>
            </select>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Commande</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Client</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Produits</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Statut</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-table" class="bg-white divide-y divide-gray-200">
                    <!-- Orders will be loaded here -->
                </tbody>
            </table>
        </div>
        <div id="loading" class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-green-600 text-2xl"></i>
            <p class="text-gray-600 mt-2">Chargement des commandes...</p>
        </div>
        <div id="no-orders" class="text-center py-8 hidden">
            <i class="fas fa-shopping-cart text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-600">Aucune commande trouvée</p>
        </div>
    </div>
</div>

<!-- Add Order Modal -->
<div id="add-order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <h3 class="text-xl font-bold mb-6">Créer une nouvelle commande</h3>
        <form id="add-order-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">ID Utilisateur</label>
                    <input type="number" id="order-user-id" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">ID Produit</label>
                    <input type="number" id="order-product-id" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Quantité</label>
                <input type="number" id="order-quantity" min="1" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideAddOrderModal()"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800">Annuler</button>
                <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">Créer</button>
            </div>
        </form>
    </div>
</div>

<script>
    let allOrders = [];
    let allProducts = [];
    let allUsers = [];

    // Charger les données
    function loadData() {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('no-orders').classList.add('hidden');

        Promise.all([
            fetch('/api/orders/').then(res => res.json()),
            fetch('/api/products/').then(res => res.json()),
            fetch('/api/users/').then(res => res.json())
        ]).then(([orders, products, users]) => {
            allOrders = orders.results || []; // CORRECTION: Utiliser orders.results
            allProducts = products.results || []; // CORRECTION: Utiliser products.results
            allUsers = users.results || []; // CORRECTION: Utiliser users.results
            document.getElementById('loading').classList.add('hidden');
            updateOrdersTable();
            updateStats();
        })
            .catch(error => {
                console.error('Erreur:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('no-orders').classList.remove('hidden');
            });
    }

    // Mettre à jour le tableau des commandes
    function updateOrdersTable() {
        const table = document.getElementById('orders-table');
        const filteredOrders = filterAndSortOrders();

        if (filteredOrders.length === 0) {
            table.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-600">Aucune commande trouvée</td></tr>';
            return;
        }

        table.innerHTML = filteredOrders.map(order => `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4">
                <div class="flex items-center">
                    <div class="bg-green-100 rounded-full p-2 mr-3">
                        <i class="fas fa-shopping-cart text-green-600 text-sm"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">#${order.id}</div>
                        <div class="text-sm text-gray-500">Commande</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center">
                    <div class="bg-purple-100 rounded-full p-2 mr-3">
                        <i class="fas fa-user text-purple-600 text-sm"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">${order.user_name || `Utilisateur ${order.user}`}</div>
                        <div class="text-sm text-gray-500">ID: ${order.user}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-900">
                    <div class="font-medium">${order.product_name || `Produit ${order.product_id}`}</div>
                    <div class="text-gray-500">Qté: ${order.quantity}</div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm font-bold text-gray-900">${parseFloat(order.total_amount).toFixed(2)}€</div>
            </td>
            <td class="px-6 py-4">
                ${getStatusBadge(order.status)}
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-900">${formatDate(order.created_at)}</div>
            </td>
            <td class="px-6 py-4">
                <div class="flex space-x-2">
                    <button onclick="viewOrder(${order.id})" class="text-blue-600 hover:text-blue-800" title="Voir">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="editOrder(${order.id})" class="text-green-600 hover:text-green-800" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteOrder(${order.id})" class="text-red-600 hover:text-red-800" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    }

    // Obtenir le badge de statut
    function getStatusBadge(status) {
        const statusConfig = {
            'pending': { color: 'yellow', icon: 'clock', text: 'En attente' },
            'processing': { color: 'blue', icon: 'cog', text: 'En cours' },
            'shipped': { color: 'purple', icon: 'truck', text: 'Expédiée' },
            'delivered': { color: 'green', icon: 'check', text: 'Livrée' },
            'cancelled': { color: 'red', icon: 'times', text: 'Annulée' }
        };

        const config = statusConfig[status] || { color: 'gray', icon: 'question', text: status };
        return `<span class="status-badge bg-${config.color}-100 text-${config.color}-800">
        <i class="fas fa-${config.icon} mr-1"></i>${config.text}
    </span>`;
    }

    // Formater la date
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Filtrer et trier les commandes
    function filterAndSortOrders() {
        let filtered = [...allOrders];

        // Filtrer par recherche
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(o =>
                o.id.toString().includes(searchTerm) ||
                (o.user_name && o.user_name.toLowerCase().includes(searchTerm)) ||
                (o.product_name && o.product_name.toLowerCase().includes(searchTerm)) ||
                o.user.toString().includes(searchTerm)
            );
        }

        // Filtrer par statut
        const statusFilter = document.getElementById('status-filter').value;
        if (statusFilter) {
            filtered = filtered.filter(o => o.status === statusFilter);
        }

        // Trier
        const sortBy = document.getElementById('sort-select').value;
        filtered.sort((a, b) => {
            switch (sortBy) {
                case 'created': return new Date(b.created_at) - new Date(a.created_at);
                case 'total': return parseFloat(b.total_amount) - parseFloat(a.total_amount);
                case 'status': return a.status.localeCompare(b.status);
                default: return 0;
            }
        });

        return filtered;
    }

    // Mettre à jour les statistiques
    function updateStats() {
        const totalOrders = allOrders.length;
        const pendingOrders = allOrders.filter(o => o.status === 'pending').length;
        const completedOrders = allOrders.filter(o => o.status === 'delivered').length;
        const totalRevenue = allOrders.reduce((sum, o) => sum + parseFloat(o.total_amount), 0);

        document.getElementById('total-orders').innerText = totalOrders;
        document.getElementById('pending-orders').innerText = pendingOrders;
        document.getElementById('completed-orders').innerText = completedOrders;
        document.getElementById('total-revenue').innerText = totalRevenue.toFixed(2) + '€';
    }

    // Modal functions
    function showAddOrderModal() {
        document.getElementById('add-order-modal').classList.remove('hidden');
    }

    function hideAddOrderModal() {
        document.getElementById('add-order-modal').classList.add('hidden');
        document.getElementById('add-order-form').reset();
    }

    // Ajouter une commande
    document.getElementById('add-order-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const order = {
            user_id: parseInt(document.getElementById('order-user-id').value),
            product_id: parseInt(document.getElementById('order-product-id').value),
            quantity: parseInt(document.getElementById('order-quantity').value)
        };

        fetch('/api/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(order)
        })
            .then(res => res.json())
            .then(data => {
                hideAddOrderModal();
                loadData();
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de la création de la commande');
            });
    });

    // Écouteurs d'événements
    document.getElementById('search-input').addEventListener('input', updateOrdersTable);
    document.getElementById('status-filter').addEventListener('change', updateOrdersTable);
    document.getElementById('sort-select').addEventListener('change', updateOrdersTable);

    // Fonctions placeholder pour visualisation, édition et suppression
    function viewOrder(id) {
        const order = allOrders.find(o => o.id === id);
        if (order) {
            alert(`Détails de la commande #${order.id}\n\nClient: ${order.user_name}\nProduit: ${order.product_name}\nQuantité: ${order.quantity}\nTotal: ${order.total_amount}€\nStatut: ${order.status}`);
        }
    }

    function editOrder(id) {
        alert('Fonction d\'édition à implémenter');
    }

    function deleteOrder(id) {
        if (confirm('Êtes-vous sûr de vouloir supprimer cette commande ?')) {
            alert('Fonction de suppression à implémenter');
        }
    }

    // Helper pour obtenir le token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Charger les données au chargement de la page
    loadData();
</script>
{% endblock %}