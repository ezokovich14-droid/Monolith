{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-chart-line text-purple-600 mr-3"></i>
            Dashboard Analytique
        </h2>
        <p class="text-gray-600 mt-2">Vue d'ensemble de votre activit√© e-commerce</p>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white hover-scale">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <i class="fas fa-box text-white text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="dashboard-products-count">0</div>
                    <div class="text-blue-100 text-sm">Produits</div>
                </div>
            </div>
            <div class="text-blue-100 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                Catalogue complet
            </div>
        </div>

        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white hover-scale">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <i class="fas fa-shopping-cart text-white text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="dashboard-orders-count">0</div>
                    <div class="text-green-100 text-sm">Commandes</div>
                </div>
            </div>
            <div class="text-green-100 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="recent-orders">0</span> aujourd'hui
            </div>
        </div>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white hover-scale">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <i class="fas fa-euro-sign text-white text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="dashboard-revenue">0‚Ç¨</div>
                    <div class="text-purple-100 text-sm">Chiffre d'affaires</div>
                </div>
            </div>
            <div class="text-purple-100 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="avg-order-value">0‚Ç¨</span> par commande
            </div>
        </div>

        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white hover-scale">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <i class="fas fa-users text-white text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="dashboard-users-count">0</div>
                    <div class="text-orange-100 text-sm">Clients</div>
                </div>
            </div>
            <div class="text-orange-100 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                Actifs cette semaine
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Orders Status Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-chart-pie text-blue-600 mr-2"></i>
                R√©partition des commandes par statut
            </h3>
            <div class="space-y-3" id="status-chart">
                <!-- Status bars will be loaded here -->
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-clock text-green-600 mr-2"></i>
                Activit√© r√©cente
            </h3>
            <div class="space-y-3" id="recent-activity">
                <!-- Recent activities will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Detailed Stats -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Top Products -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                Produits populaires
            </h3>
            <div class="space-y-2" id="top-products">
                <!-- Top products will be loaded here -->
            </div>
        </div>

        <!-- Stock Status -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-warehouse text-orange-600 mr-2"></i>
                √âtat des stocks
            </h3>
            <div class="space-y-2" id="stock-status">
                <!-- Stock status will be loaded here -->
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-tachometer-alt text-purple-600 mr-2"></i>
                M√©triques de performance
            </h3>
            <div class="space-y-3" id="performance-metrics">
                <!-- Performance metrics will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-bolt text-yellow-500 mr-2"></i>
            Actions rapides
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <a href="/products/" class="bg-white rounded-lg p-4 text-center hover:shadow-md transition-shadow">
                <i class="fas fa-plus-circle text-blue-600 text-2xl mb-2"></i>
                <div class="text-sm font-medium text-gray-700">Ajouter un produit</div>
            </a>
            <a href="/orders/" class="bg-white rounded-lg p-4 text-center hover:shadow-md transition-shadow">
                <i class="fas fa-shopping-cart text-green-600 text-2xl mb-2"></i>
                <div class="text-sm font-medium text-gray-700">Nouvelle commande</div>
            </a>
            <a href="/admin/" class="bg-white rounded-lg p-4 text-center hover:shadow-md transition-shadow">
                <i class="fas fa-cog text-purple-600 text-2xl mb-2"></i>
                <div class="text-sm font-medium text-gray-700">Administration</div>
            </a>
            <button onclick="exportData()" class="bg-white rounded-lg p-4 text-center hover:shadow-md transition-shadow">
                <i class="fas fa-download text-orange-600 text-2xl mb-2"></i>
                <div class="text-sm font-medium text-gray-700">Exporter les donn√©es</div>
            </button>
        </div>
    </div>
</div>

<script>
let allProducts = [];
let allOrders = [];
let allUsers = [];

// Charger les donn√©es du dashboard
function loadDashboardData() {
    Promise.all([
        fetch('/api/products/').then(r => r.json()),
        fetch('/api/orders/').then(r => r.json()),
        fetch('/api/users/').then(r => r.json())
    ]).then(([products, orders, users]) => {
        allProducts = products.results || []; // CORRECTION: Utiliser products.results
        allOrders = orders.results || []; // CORRECTION: Utiliser orders.results
        allUsers = users.results || []; // CORRECTION: Utiliser users.results
        
        updateKPICards();
        updateStatusChart();
        updateRecentActivity();
        updateTopProducts();
        updateStockStatus();
        updatePerformanceMetrics();
    })
    .catch(error => {
        console.error('Erreur lors du chargement des donn√©es:', error);
    });
}

// Mettre √† jour les cartes KPI
function updateKPICards() {
    const totalProducts = allProducts.length;
    const totalOrders = allOrders.length;
    const totalUsers = allUsers.length;
    const totalRevenue = allOrders.reduce((sum, o) => sum + parseFloat(o.total_amount), 0);
    const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
    
    document.getElementById('dashboard-products-count').innerText = totalProducts;
    document.getElementById('dashboard-orders-count').innerText = totalOrders;
    document.getElementById('dashboard-users-count').innerText = totalUsers;
    document.getElementById('dashboard-revenue').innerText = totalRevenue.toFixed(2) + '‚Ç¨';
    document.getElementById('avg-order-value').innerText = avgOrderValue.toFixed(2) + '‚Ç¨';
    
    // Calculer les commandes aujourd'hui (simulation)
    const today = new Date().toDateString();
    const todayOrders = allOrders.filter(o => {
        return o.created_at && new Date(o.created_at).toDateString() === today;
    }).length;
    document.getElementById('recent-orders').innerText = todayOrders;
}

// Mettre √† jour le graphique de statut
function updateStatusChart() {
    const statusCounts = {};
    allOrders.forEach(order => {
        statusCounts[order.status] = (statusCounts[order.status] || 0) + 1;
    });
    
    const statusConfig = {
        'pending': { label: 'En attente', color: 'yellow' },
        'processing': { label: 'En cours', color: 'blue' },
        'shipped': { label: 'Exp√©di√©e', color: 'purple' },
        'delivered': { label: 'Livr√©e', color: 'green' },
        'cancelled': { label: 'Annul√©e', color: 'red' }
    };
    
    const chartContainer = document.getElementById('status-chart');
    chartContainer.innerHTML = Object.entries(statusCounts).map(([status, count]) => {
        const config = statusConfig[status] || { label: status, color: 'gray' };
        const percentage = allOrders.length > 0 ? (count / allOrders.length * 100).toFixed(1) : 0;
        
        return `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-${config.color}-500 rounded-full mr-3"></div>
                    <span class="text-sm font-medium text-gray-700">${config.label}</span>
                </div>
                <div class="flex items-center">
                    <div class="w-24 bg-gray-200 rounded-full h-2 mr-3">
                        <div class="bg-${config.color}-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-900 w-12 text-right">${count}</span>
                </div>
            </div>
        `;
    }).join('');
}

// Mettre √† jour l'activit√© r√©cente
function updateRecentActivity() {
    const recentOrders = allOrders
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 5);
    
    const activityContainer = document.getElementById('recent-activity');
    if (recentOrders.length === 0) {
        activityContainer.innerHTML = '<p class="text-gray-500 text-sm">Aucune activit√© r√©cente</p>';
        return;
    }
    
    activityContainer.innerHTML = recentOrders.map(order => {
        const timeAgo = getTimeAgo(order.created_at);
        const statusIcon = getStatusIcon(order.status);
        
        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <div class="bg-blue-100 rounded-full p-2 mr-3">
                        <i class="fas fa-shopping-cart text-blue-600 text-xs"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">Commande #${order.id}</div>
                        <div class="text-xs text-gray-500">${order.user_name || 'Client'} - ${order.total_amount}‚Ç¨</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">${timeAgo}</div>
                    <div class="text-xs">${statusIcon}</div>
                </div>
            </div>
        `;
    }).join('');
}

// Mettre √† jour les produits populaires
function updateTopProducts() {
    const productCounts = {};
    allOrders.forEach(order => {
        const productKey = order.product_name || `Produit ${order.product_id}`;
        productCounts[productKey] = (productCounts[productKey] || 0) + order.quantity;
    });
    
    const topProducts = Object.entries(productCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    const container = document.getElementById('top-products');
    if (topProducts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Aucune vente enregistr√©e</p>';
        return;
    }
    
    container.innerHTML = topProducts.map(([productName, quantity], index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
        return `
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <div class="flex items-center">
                    <span class="mr-2">${medal}</span>
                    <span class="text-sm font-medium text-gray-700 truncate max-w-32">${productName}</span>
                </div>
                <span class="text-sm font-bold text-gray-900">${quantity}</span>
            </div>
        `;
    }).join('');
}

// Mettre √† jour l'√©tat des stocks
function updateStockStatus() {
    const inStock = allProducts.filter(p => p.stock > 10).length;
    const lowStock = allProducts.filter(p => p.stock > 0 && p.stock <= 10).length;
    const outOfStock = allProducts.filter(p => p.stock === 0).length;
    
    const container = document.getElementById('stock-status');
    container.innerHTML = `
        <div class="flex items-center justify-between p-2 bg-green-50 rounded">
            <span class="text-sm text-green-700">‚úì En stock</span>
            <span class="text-sm font-bold text-green-700">${inStock}</span>
        </div>
        <div class="flex items-center justify-between p-2 bg-yellow-50 rounded">
            <span class="text-sm text-yellow-700">‚ö† Stock faible</span>
            <span class="text-sm font-bold text-yellow-700">${lowStock}</span>
        </div>
        <div class="flex items-center justify-between p-2 bg-red-50 rounded">
            <span class="text-sm text-red-700">‚úó Rupture</span>
            <span class="text-sm font-bold text-red-700">${outOfStock}</span>
        </div>
    `;
}

// Mettre √† jour les m√©triques de performance
function updatePerformanceMetrics() {
    const totalRevenue = allOrders.reduce((sum, o) => sum + parseFloat(o.total_amount), 0);
    const avgOrderValue = allOrders.length > 0 ? totalRevenue / allOrders.length : 0;
    const conversionRate = allUsers.length > 0 ? (allOrders.length / allUsers.length * 100) : 0;
    
    const container = document.getElementById('performance-metrics');
    container.innerHTML = `
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600">Panier moyen</span>
            <span class="text-sm font-bold text-gray-900">${avgOrderValue.toFixed(2)}‚Ç¨</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600">Taux de conversion</span>
            <span class="text-sm font-bold text-gray-900">${conversionRate.toFixed(1)}%</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600">Valeur totale stock</span>
            <span class="text-sm font-bold text-gray-900">${calculateStockValue()}‚Ç¨</span>
        </div>
    `;
}

// Fonctions utilitaires
function getTimeAgo(dateString) {
    if (!dateString) return 'Inconnue';
    const date = new Date(dateString);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    
    if (diff < 60) return 'Il y a quelques secondes';
    if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
    if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)} h`;
    return `Il y a ${Math.floor(diff / 86400)} j`;
}

function getStatusIcon(status) {
    const icons = {
        'pending': '<i class="fas fa-clock text-yellow-500"></i>',
        'processing': '<i class="fas fa-cog text-blue-500"></i>',
        'shipped': '<i class="fas fa-truck text-purple-500"></i>',
        'delivered': '<i class="fas fa-check text-green-500"></i>',
        'cancelled': '<i class="fas fa-times text-red-500"></i>'
    };
    return icons[status] || '<i class="fas fa-question text-gray-500"></i>';
}

function calculateStockValue() {
    return allProducts.reduce((sum, p) => sum + (parseFloat(p.price) * p.stock), 0).toFixed(2);
}

function exportData() {
    const data = {
        products: allProducts,
        orders: allOrders,
        users: allUsers,
        exportDate: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dashboard-export-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Charger les donn√©es au chargement de la page
loadDashboardData();
</script>
{% endblock %}
